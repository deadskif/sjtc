 <!DOCTYPE html>
<html lang="ru">
<meta charset="UTF-8">
<title>Simple Jimny Transmission Calc</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="">
<style>
table, th, td {
  border: 1px solid;
}
</style>
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <!-- <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>-->
<script>

function gearbox(gearboxes) {
    var values = {};
    for (let gb of gearboxes) {
        values[gb.name] = gb.ratios;
        for (let kit of gb.kits) {
            kgears = kit.match('^\([^ ]*\) *\([+]\([0-9]+\)%H/[+]\([0-9]+\)%L|[0-9]\.[0-9]+\)')
            if (kgears !== null) {
                if (kgears[3] !== undefined) {
                    /* HG +17%H/+108%L */
                    const hi = (1+(kgears[3]/100.0));
                    const lo = (1+(kgears[4]/100.0));
                      
                    values[gb.name+' '+kit] = [
                        gb.ratios[0] * hi,
                        gb.ratios[1] * lo
                    ];
                    values[gb.name+' '+kgears[1]+' +'+kgears[3]+'%H'] = [
                        gb.ratios[0] * hi,
                        gb.ratios[1] * hi
                    ];
                    values[gb.name+' '+kgears[1]+' +'+kgears[4]+'%L'] = [
                        gb.ratios[0],
                        gb.ratios[1] * lo/hi
                    ];
                } else {
                    console.log("LOW", kgears);
                    values[gb.name+' '+kit] = [
                        gears[0],
                        kgears[2]
                    ];
                }
            }
        }
    }
    return values;
}
function Transmission(init) {
    this.type = init.type;
    this.header = init.header;
    this.names = init.names || [''];
    this.values = init.values;
};
Transmission.prototype.selector = function(cfg) {
    const type = this.type;
    const values = this.values;
    var sel = $('<select id="'+this.type+cfg+'"/>')
            .on("change", function(ev) {
                var t = ev.target.selectedOptions[0].value;
                $('[id^="'+type+cfg+'_"]').each(function(i, inp) {
                    inp.value = values[t][i];
                });
                TABLES.forEach((v) => v.calc());
            })
    [0];
    //console.log('select = ', sel);
    for (let name in this.values) {
        sel.appendChild($('<option />')
            .val(name)
            .html(name)
            [0]);
    }
    return sel;
}
Transmission.prototype.inputs = function(cfg) {
    var ins = [];
    for (let i = 0; i < this.names.length; i++) {
        ins.push($('<input id="'+this.type+cfg+'_'+i+'" />').on("change",
            (ev) => TABLES.forEach((v) => v.calc()))[0]);
    }
    return ins;
}
Transmission.prototype.cols = function(cols, n) {
    cols[0].push(this.header);
    cols[0] = cols[0].concat(this.names);

    for (let i = 1; i <= n; i++) {
        cols[i].push(this.selector(i));
        cols[i] = cols[i].concat(this.inputs(i));
    }
}
function ResultTable(name, col_names, cfg, gb) {
    this.col_names = col_names;
    this.row_names = DB[TRANSMISSION].names;
    this.name = name;
    this.cfg = cfg
    this.gb = gb;
    var table = this;

    var rows = [[DB[GEARBOX].names[gb]].concat(this.col_names)].concat(this.row_names.map(
        (v) => [v].concat(this.col_names.map((v) => ""))
    ));

    var resultt = $("#" + name);
    resultt.html(rows.map(function(row, i) {
        var tr = $('<tr/>');
        tr.html(row.map(function(val, j) {
            var tdid = '';
            if ((i > 0) && (j > 0))
                tdid = 'id="'+table.cellid(i-1, j-1) +'"';
            var c = $('<td '+tdid+'/>').html(val)[0];
            return c;
        }));
        return tr[0];
    }));

}
ResultTable.prototype.cellid = function(i, j) {
    return this.name + '_' + i + '_' + j;
}
ResultTable.prototype.value = function(i, j, val) {
    var c = $('td#'+this.cellid(i,j))[0];
    if (val == undefined) {
        return c.innerHTML;
    }
    c.innerHTML = val;
}
ResultTable.prototype.calc = function() {
    for (let i = 0; i < this.row_names.length; i++) {
        for (let j = 0; j < this.col_names.length; j++) {
            var v = this.col_names[j]; // rpm
            v /= $('#transmission'+this.cfg+'_'+i)[0].value;
            v /= $('#gearbox'+this.cfg+'_'+this.gb)[0].value;
            v /= $('#pairs'+this.cfg+'_'+0)[0].value; //rpm
            v *= $('#wheel'+this.cfg+'_0')[0].value * Math.PI * 25.4 / 1000; //meter / minute
            v *= 60 / 1000; //km/h
            v = isFinite(v) ? Math.round(v*10)/10 : 'N/A';
            this.value(i, j, v);
        }
    }
}
GEARBOXES = [{
    name: '1.3/2.6',
    ratios: [1.32, 2.64],
    kits: ['HF +15%H/+75%L', 'TG +15%H/+104%L'],
},{
    name: '1.0/2.0',
    ratios: [1.0, 2.0],
    kits: ['TG +17%H/+87%L'],
}];
DB = [
    new Transmission({
        type: 'wheel',
        header: 'Колесо',
        values: {
            '205/70R15': [26.3],
            '215/75R15': [27.7],
            '235/75R15': [28.9],
        }}),
    new Transmission({
        type: 'transmission',
        header: 'КПП',
        names: ['КПП 1', 'КПП 2','КПП 3','КПП 4','КПП 5', 'КПП R'],
        values: {
            'АКПП TW40-LE': [2.875, 1.568, 1.000, 0.696, '',    2.300],
            'МКПП R72':     [4.425, 2.304, 1.674, 1.190, 1.000, 5.151],
        }}),
    new Transmission({
        type: 'gearbox',
        header: 'РК',
        names: ['HI', 'LO'],
        values: gearbox(GEARBOXES)
        }),
    new Transmission({
        type: 'pairs',
        header: 'ГП',
        values: {
            '4.09': [4.09],
            '4.3': [4.3],
        }}),
];
const TRANSMISSION = 1;
const GEARBOX = 2;
function cols_push(cols, ap) {
    for (let i = 0; i < cols.length; i++) {
        cols[i].push(ap[i]);
    }
}
function init_data(name, cfg) {

    var cols = [['']].concat(Array(cfg).fill("Config ").map((v, i) => [v + i]));

    for (let tr of DB) {
        tr.cols(cols,cfg);
    }

    var datat = $("#" + name)[0];
    for (let rown = 0; rown < cols[0].length; rown++) {
        var tr = $('<tr/>')[0];
        for (let coln = 0; coln < cols.length; coln++) {
            var c = $('<td/>').html(cols[coln][rown])[0];
            tr.appendChild(c);
        }
        datat.appendChild(tr);
    }
}
var TABLES = [];
function init_result(name, cfg, gb) {
    TABLES.push(new ResultTable(name,
        [1000, 2000, 3000, 4000, 5000, 6000, 7000],
        cfg, gb));
}
function init() {
    init_data('data', 2);
    init_result('result1_hi', 1, 0);
    init_result('result1_lo', 1, 1);
    init_result('result2_hi', 2, 0);
    init_result('result2_lo', 2, 1);
    $("select").change();
}
</script>
<body onload="init()">
    <table id="data"></table>
    <div id='calc'></div>
    <table>
        <tr>
            <td><table id="result1_hi"></table></td><td><table id="result2_hi"></table></td>
        </tr>
        <tr>
            <td><table id="result1_lo"></table></td><td><table id="result2_lo"></table></td>
        </tr>
    </table>
</body>
</html> 
